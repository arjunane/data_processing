/*﻿

SELECT	sum(area_ha), substr(nuts,1,5) 
	INTO 	orig_consumption_znes.temp_table
	FROM 	calc_gridcells_znes.landuse_industrial
GROUP BY 	substr(nuts,1,5);

UPDATE orig_consumption_znes.lak_consumption_per_district a
	SET 	area_industry = sum
	FROM 	orig_consumption_znes.temp_table b
	WHERE 	b.substr = substr(a.eu_code,1,5);

DROP TABLE orig_consumption_znes.temp_table; 


-- Calculate industrial consumption per industry polygon

UPDATE 	orig_consumption_znes.lak_consumption_per_district
SET 	consumption_per_area_industry = elec_consumption_industry/area_industry;

*/


DROP TABLE IF EXISTS calc_ego_loads_industry.large_scale_consumer;

CREATE TABLE calc_ego_loads_industry.large_scale_consumer AS
	(
	SELECT	osm_deu_polygon_urban_sector_3_industrial_mview.gid AS polygon_id,
		osm_deu_polygon_urban_sector_3_industrial_mview.area_ha AS area_ha,
		proc_power_plant_germany.gid AS powerplant_id,
		proc_power_plant_germany.voltage_level AS voltage_level
	FROM 	orig_geo_powerplants.proc_power_plant_germany, 
		orig_osm. osm_deu_polygon_urban_sector_3_industrial_mview
	WHERE	(voltage_level='3' OR voltage_level='2'OR voltage_level='1')
	AND 	ST_Intersects (proc_power_plant_germany.geom, (ST_transform (osm_deu_polygon_urban_sector_3_industrial_mview.geom,4326))));


DELETE FROM calc_ego_loads_industry.large_scale_consumer
WHERE polygon_id IN (SELECT polygon_id
              FROM (SELECT polygon_id,
                             ROW_NUMBER() OVER (partition BY powerplant_id ORDER BY (-area_ha)) AS rnum
                     FROM calc_ego_loads_industry.large_scale_consumer) t
              WHERE t.rnum > 1);

ALTER TABLE calc_ego_loads_industry.large_scale_consumer
	ADD COLUMN id serial, 
	ADD COLUMN consumption numeric, 
	ADD COLUMN peak_load numeric,
	ADD COLUMN geom_centre geometry(Point,3035),
	ADD PRIMARY KEY (id);

ALTER TABLE calc_ego_loads_industry.large_scale_consumer ALTER COLUMN polygon_id SET DEFAULT NULL;


----------------
-- Add industrial areas where limit value of peak load exceeds 17.5 MW
----------------

INSERT INTO calc_ego_loads_industry.large_scale_consumer (polygon_id, area_ha) 
	SELECT gid, area_ha
	FROM calc_ego_loads_industry.landuse_industry
	WHERE peak_load >= 0.0175; 

-- Add consumption, peak_load and geom_centre for industry polygons

UPDATE calc_ego_loads_industry.large_scale_consumer
	SET geom_centre = b.geom_centre 
	FROM calc_ego_loads_industry.landuse_industry b
	WHERE polygon_id = b.gid;

UPDATE calc_ego_loads_industry.large_scale_consumer
	SET consumption = b.consumption 
	FROM calc_ego_loads_industry.landuse_industry b
	WHERE polygon_id = b.gid;  

UPDATE calc_ego_loads_industry.large_scale_consumer
	SET peak_load = b.peak_load 
	FROM calc_ego_loads_industry.landuse_industry b
	WHERE polygon_id = b.gid;
 
-- Update voltage_level for polygons without powerplant 

UPDATE calc_ego_loads_industry.large_scale_consumer
	SET voltage_level = '3'
	WHERE peak_load >= 0.0175 AND peak_load < 0.12 AND powerplant_id IS NULL; 

UPDATE calc_ego_loads_industry.large_scale_consumer
	SET voltage_level = '1'
	WHERE peak_load >= 0.12 AND powerplant_id IS NULL; 


-- Delete duplicates of polygon_id with the same voltage_level 

DELETE FROM calc_ego_loads_industry.large_scale_consumer
WHERE id IN (SELECT id
              FROM (SELECT id,
                             ROW_NUMBER() OVER (partition BY polygon_id, voltage_level ORDER BY (id)) AS rnum
                     FROM calc_ego_loads_industry.large_scale_consumer) t
              WHERE t.rnum > 1);

-- Delete duplicates of polygon_id ordered by voltage_level 

DELETE FROM calc_ego_loads_industry.large_scale_consumer
WHERE id IN (SELECT id
              FROM (SELECT id,
                             ROW_NUMBER() OVER (partition BY polygon_id ORDER BY (voltage_level)) AS rnum
                     FROM calc_ego_loads_industry.large_scale_consumer) t
              WHERE t.rnum > 1);

/*﻿ 
SELECT polygon_id, 
 COUNT(polygon_id) AS NumOccurrences
FROM calc_ego_loads_industry.large_scale_consumer
GROUP BY polygon_id
HAVING ( COUNT(polygon_id) > 1 )
*/





